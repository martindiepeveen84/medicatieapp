<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Zorg & Hulpmiddelen App</title>
  <meta name="theme-color" content="#6366f1">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <style>
    body { font-family: system-ui, sans-serif; background: #f3f4f6; margin: 0; color: #1f2937;}
    header { background: linear-gradient(90deg, #e0e7ff 60%, #f3f4f6 100%); color: #222;
      font-weight: bold; font-size: 1.2em; padding: 1em 1em 1em 3.5em; border-left: 6px solid #6366f1; position: relative;}

    .hamburger { position: absolute; left: 0.75em; top: 1em; width: 2em; height: 2em; background: none; border: none; z-index: 50; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .hamburger span { width: 1.6em; height: 0.25em; background: #6366f1; margin: 0.18em 0; border-radius: 2px; display: block; transition: all 0.3s; }
    .hamburger.open span:nth-child(1) { transform: rotate(45deg) translate(7px,7px);}
    .hamburger.open span:nth-child(2) { opacity: 0;}
    .hamburger.open span:nth-child(3) { transform: rotate(-45deg) translate(7px,-7px);}

    .side-menu { position: fixed; top: 0; left: 0; height: 100vh; width: 240px; background: #e0e7ff; box-shadow: 2px 0 16px #2221; z-index: 100; transform: translateX(-100%); transition: transform 0.25s; display: flex; flex-direction: column; padding-top: 4em; }
    .side-menu.open { transform: translateX(0);}
    .side-menu button { background: none; border: none; font-size: 1.05em; font-weight: bold; color: #222; padding: 1.1em 1.2em; text-align: left; width: 100%; cursor: pointer; border-bottom: 1px solid #c7d2fe; transition: background 0.15s; }
    .side-menu button.active { background: #6366f1; color: #fff; border-radius: 0 1.2em 1.2em 0; }

    .menu-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.2); z-index: 90; }
    .menu-overlay.open { display: block;}

    section { display: none; padding: 1em; max-width: 800px; margin: 0 auto; }
    section.active { display: block; }
    
    .card { background: #fff; margin: .75em 0; padding: 1em; border-radius: 12px; box-shadow: 0 4px 12px #6366f115; position: relative; }
    .card .title { font-weight: bold; color: #4338ca; font-size: 1.1em; display: block; margin-bottom: 4px; }
    .card .subtitle { color: #6b7280; font-size: 0.85em; }
    
    .plus-btn { float: right; background: #6366f1; color: #fff; border: none; border-radius: 50%; width: 2.5em; height: 2.5em; font-size: 1.2em; cursor: pointer; box-shadow: 0 4px 10px #6366f144; }
    
    label { font-weight: 600; margin-top: 1em; color: #374151; display: block; font-size: 0.9em; }
    input, select, textarea { font-size:1em; padding:.6em; margin-top:.3em; width: 100%; border-radius: 8px; border: 1px solid #d1d5db; box-sizing: border-box; }
    
    .btn { background: #6366f1; color: #fff; border: none; border-radius: 8px; padding: .7em 1.2em; font-weight: bold; cursor: pointer; display: inline-block; margin-top: 10px; }
    .btn-secondary { background: #94a3b8; }
    .btn-small { padding: 0.4em 0.8em; font-size: 0.85em; }
    
    .delete-icon { position: absolute; right: 1em; top: 1em; color: #ef4444; cursor: pointer; font-size: 1.2em; }
    .edit-icon { position: absolute; right: 3em; top: 1em; color: #6366f1; cursor: pointer; font-size: 1.2em; }
    
    .bestellijst-container { border: 2px solid #6366f1; border-radius: 12px; padding: 1em; margin-top: 1em; background: #fdfdfd; }
    .leverancier-header { background: #6366f1; color: white; padding: 8px 12px; border-radius: 6px; margin: 15px 0 8px 0; font-weight: bold; }
    
    .badge { padding: 2px 8px; border-radius: 12px; font-size: 0.75em; background: #e0e7ff; color: #4338ca; font-weight: bold; }
    .foto-preview { max-width: 100px; border-radius: 8px; margin-top: 8px; border: 1px solid #ddd; }
  </style>
</head>
<body>

  <header>
    <button class="hamburger" id="hamburger-btn">
      <span></span><span></span><span></span>
    </button>
    ðŸ“¦ Zorg Beheer
  </header>

  <div class="menu-overlay" id="menu-overlay"></div>

  <aside class="side-menu" id="side-menu">
    <button data-section="items" class="active">Artikelen & Voorraad</button>
    <button data-section="leveranciers">Leveranciers</button>
    <button data-section="bestellen">Bestellen</button>
    <button data-section="instellingen">Instellingen</button>
  </aside>

  <section id="s-items" class="active">
    <button id="add-item-btn" class="plus-btn">+</button>
    <h2>Voorraadbeheer</h2>
    <div id="items-lijst"></div>
    
    <div id="item-form-div" style="display:none;" class="card">
      <h3 id="form-title">Artikel toevoegen</h3>
      <form id="item-form">
        <input type="hidden" name="id">
        <label>Naam artikel (bijv. Enfit spuit 50ml, Paracetamol)</label>
        <input name="naam" required placeholder="bijv. Nutrison sondevoeding">
        
        <label>Categorie</label>
        <select name="categorie">
          <option>Medicatie</option>
          <option>Sondevoeding / Voeding</option>
          <option>Stomazorg</option>
          <option>Longzorg / Uitzuigen</option>
          <option>Inco materiaal</option>
          <option>Overig</option>
        </select>

        <label>Leverancier</label>
        <select name="leverancier_id" id="form-leverancier-select"></select>

        <label>Verbruik per dag (aantal/ml/stuk)</label>
        <input name="verbruik_per_dag" type="number" step="0.01" required>

        <label>Huidige voorraad (aantal verpakkingen)</label>
        <input name="huidige_voorraad_verp" type="number" step="1" value="0">

        <label>Inhoud per verpakking (stuks/ml/ampullen)</label>
        <input name="inhoud_per_verp" type="number" step="0.01" required>

        <label>Foto (optioneel)</label>
        <input type="file" accept="image/*" capture="environment" id="item-foto-input">
        <img id="item-foto-preview" class="foto-preview" style="display:none">

        <div style="margin-top:1.5em">
          <button type="submit" class="btn">Opslaan</button>
          <button type="button" class="btn btn-secondary" onclick="hideForms()">Annuleren</button>
        </div>
      </form>
    </div>
  </section>

  <section id="s-leveranciers">
    <button id="add-leverancier-btn" class="plus-btn">+</button>
    <h2>Leveranciers</h2>
    <div id="leveranciers-lijst"></div>

    <div id="leverancier-form-div" style="display:none;" class="card">
      <h3>Leverancier toevoegen</h3>
      <form id="leverancier-form">
        <input type="hidden" name="id">
        <label>Naam leverancier</label>
        <input name="naam" required placeholder="bijv. Mediq, Apotheek X">
        <label>E-mailadres voor bestellingen</label>
        <input name="email" type="email" required placeholder="bestelling@leverancier.nl">
        <div style="margin-top:1.5em">
          <button type="submit" class="btn">Opslaan</button>
          <button type="button" class="btn btn-secondary" onclick="hideForms()">Annuleren</button>
        </div>
      </form>
    </div>
  </section>

  <section id="s-bestellen">
    <h2>Bestellen</h2>
    <div id="bestel-overzicht"></div>
  </section>

  <section id="s-instellingen">
    <h2>Instellingen</h2>
    <label>Bestel voorraad voor hoeveel dagen?</label>
    <input id="inp-besteldagen" type="number" min="1" value="14">
    <button class="btn" onclick="saveConfig()">Instellingen Opslaan</button>
    <hr>
    <button class="btn btn-secondary" id="export-btn">Backup maken (Export JSON)</button>
  </section>

  <script>
    // --- DATABASE / STATE ---
    let state = {
      items: JSON.parse(localStorage.getItem('zorg_items') || '[]'),
      leveranciers: JSON.parse(localStorage.getItem('zorg_leveranciers') || '[]'),
      besteldagen: parseInt(localStorage.getItem('zorg_besteldagen') || '14')
    };

    function saveToDisk() {
      localStorage.setItem('zorg_items', JSON.stringify(state.items));
      localStorage.setItem('zorg_leveranciers', JSON.stringify(state.leveranciers));
      localStorage.setItem('zorg_besteldagen', state.besteldagen.toString());
    }

    // --- UI NAVIGATION ---
    const sections = document.querySelectorAll('section');
    const menuBtns = document.querySelectorAll('.side-menu button');
    const hamburger = document.getElementById('hamburger-btn');
    const sideMenu = document.getElementById('side-menu');
    const overlay = document.getElementById('menu-overlay');

    function showSection(id) {
      sections.forEach(s => s.classList.remove('active'));
      document.getElementById('s-' + id).classList.add('active');
      menuBtns.forEach(b => b.classList.toggle('active', b.dataset.section === id));
      hideForms();
      if(id === 'items') renderItems();
      if(id === 'leveranciers') renderLeveranciers();
      if(id === 'bestellen') renderBestellen();
      closeMenu();
    }

    menuBtns.forEach(btn => btn.onclick = () => showSection(btn.dataset.section));
    hamburger.onclick = () => { sideMenu.classList.toggle('open'); overlay.classList.toggle('open'); hamburger.classList.toggle('open'); };
    overlay.onclick = closeMenu;
    function closeMenu() { sideMenu.classList.remove('open'); overlay.classList.remove('open'); hamburger.classList.remove('open'); }
    function hideForms() { 
      document.getElementById('item-form-div').style.display = 'none'; 
      document.getElementById('leverancier-form-div').style.display = 'none';
      document.getElementById('items-lijst').style.display = 'block';
    }

    // --- ITEM BEHEER ---
    document.getElementById('add-item-btn').onclick = () => {
      document.getElementById('item-form').reset();
      document.getElementById('item-form').id.value = "";
      document.getElementById('item-foto-preview').style.display = 'none';
      document.getElementById('form-title').innerText = "Artikel toevoegen";
      updateLeverancierSelect();
      document.getElementById('item-form-div').style.display = 'block';
      document.getElementById('items-lijst').style.display = 'none';
    };

    function updateLeverancierSelect() {
      const select = document.getElementById('form-leverancier-select');
      select.innerHTML = '<option value="">Geen / Onbekend</option>' + 
        state.leveranciers.map(l => `<option value="${l.id}">${l.naam}</option>`).join('');
    }

    let currentFotoBase64 = "";
    document.getElementById('item-foto-input').onchange = (e) => {
      const reader = new FileReader();
      reader.onload = (ev) => {
        currentFotoBase64 = ev.target.result;
        const img = document.getElementById('item-foto-preview');
        img.src = currentFotoBase64;
        img.style.display = 'block';
      };
      reader.readAsDataURL(e.target.files[0]);
    };

    document.getElementById('item-form').onsubmit = (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const id = fd.get('id') || Date.now().toString();
      const item = {
        id,
        naam: fd.get('naam'),
        categorie: fd.get('categorie'),
        leverancier_id: fd.get('leverancier_id'),
        verbruik_per_dag: parseFloat(fd.get('verbruik_per_dag')),
        huidige_voorraad_verp: parseInt(fd.get('huidige_voorraad_verp')),
        inhoud_per_verp: parseFloat(fd.get('inhoud_per_verp')),
        foto: currentFotoBase64
      };

      const idx = state.items.findIndex(i => i.id === id);
      if(idx > -1) state.items[idx] = item; else state.items.push(item);
      
      saveToDisk();
      showSection('items');
      currentFotoBase64 = "";
    };

    function renderItems() {
      const lijst = document.getElementById('items-lijst');
      lijst.innerHTML = state.items.length ? '' : '<p>Geen artikelen gevonden.</p>';
      
      // Sorteer op categorie
      const sorted = [...state.items].sort((a,b) => a.categorie.localeCompare(b.categorie));
      
      sorted.forEach(item => {
        const lev = state.leveranciers.find(l => l.id === item.leverancier_id);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <span class="edit-icon" onclick="editItem('${item.id}')">âœŽ</span>
          <span class="delete-icon" onclick="deleteItem('${item.id}')">ðŸ—‘</span>
          <span class="badge">${item.categorie}</span>
          <span class="title">${item.naam}</span>
          <div style="display:flex; gap:10px;">
            ${item.foto ? `<img src="${item.foto}" class="foto-preview">` : ''}
            <div class="subtitle">
              Voorraad: <b>${item.huidige_voorraad_verp} verp.</b><br>
              Leverancier: ${lev ? lev.naam : 'Niet ingesteld'}<br>
              Verbruik: ${item.verbruik_per_dag} p/dag
            </div>
          </div>
        `;
        lijst.appendChild(card);
      });
    }

    window.editItem = (id) => {
      const item = state.items.find(i => i.id === id);
      const form = document.getElementById('item-form');
      form.id.value = item.id;
      form.naam.value = item.naam;
      form.categorie.value = item.categorie;
      updateLeverancierSelect();
      form.leverancier_id.value = item.leverancier_id;
      form.verbruik_per_dag.value = item.verbruik_per_dag;
      form.huidige_voorraad_verp.value = item.huidige_voorraad_verp;
      form.inhoud_per_verp.value = item.inhoud_per_verp;
      if(item.foto) {
        document.getElementById('item-foto-preview').src = item.foto;
        document.getElementById('item-foto-preview').style.display = 'block';
        currentFotoBase64 = item.foto;
      }
      document.getElementById('item-form-div').style.display = 'block';
      document.getElementById('items-lijst').style.display = 'none';
    };

    window.deleteItem = (id) => { if(confirm('Verwijderen?')) { state.items = state.items.filter(i => i.id !== id); saveToDisk(); renderItems(); } };

    // --- LEVERANCIER BEHEER ---
    document.getElementById('add-leverancier-btn').onclick = () => {
      document.getElementById('leverancier-form').reset();
      document.getElementById('leverancier-form').id.value = "";
      document.getElementById('leverancier-form-div').style.display = 'block';
    };

    document.getElementById('leverancier-form').onsubmit = (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const id = fd.get('id') || Date.now().toString();
      const lev = { id, naam: fd.get('naam'), email: fd.get('email') };
      
      const idx = state.leveranciers.findIndex(l => l.id === id);
      if(idx > -1) state.leveranciers[idx] = lev; else state.leveranciers.push(lev);
      
      saveToDisk();
      showSection('leveranciers');
    };

    function renderLeveranciers() {
      const lijst = document.getElementById('leveranciers-lijst');
      lijst.innerHTML = state.leveranciers.map(l => `
        <div class="card">
          <span class="delete-icon" onclick="deleteLev('${l.id}')">ðŸ—‘</span>
          <span class="title">${l.naam}</span>
          <span class="subtitle">${l.email}</span>
        </div>
      `).join('') || '<p>Geen leveranciers.</p>';
    }

    window.deleteLev = (id) => { if(confirm('Leverancier verwijderen?')) { state.leveranciers = state.leveranciers.filter(l => l.id !== id); saveToDisk(); renderLeveranciers(); } };

    // --- BESTELLEN LOGICA ---
    function renderBestellen() {
      const container = document.getElementById('bestel-overzicht');
      const bestelLijstPerLev = {};
      
      state.items.forEach(item => {
        const totaalNodig = item.verbruik_per_dag * state.besteldagen;
        const voorraadEenheden = item.huidige_voorraad_verp * item.inhoud_per_verp;
        
        if (voorraadEenheden < totaalNodig) {
          const tekort = totaalNodig - voorraadEenheden;
          const extraVerp = Math.ceil(tekort / item.inhoud_per_verp);
          const levId = item.leverancier_id || 'onbekend';
          
          if (!bestelLijstPerLev[levId]) bestelLijstPerLev[levId] = [];
          bestelLijstPerLev[levId].push({ naam: item.naam, aantal: extraVerp });
        }
      });

      let html = `<h3>Bestelling voor komende ${state.besteldagen} dagen</h3>`;
      
      for (const [levId, items] of Object.entries(bestelLijstPerLev)) {
        const lev = state.leveranciers.find(l => l.id === levId);
        const levNaam = lev ? lev.naam : "Onbekende Leverancier";
        
        html += `<div class="bestellijst-container">
          <div class="leverancier-header">${levNaam}</div>
          <ul>${items.map(i => `<li>${i.aantal}x ${i.naam}</li>`).join('')}</ul>
          ${lev ? `<button class="btn btn-small" onclick="mailBestelling('${lev.id}', '${encodeURIComponent(JSON.stringify(items))}')">Mail naar ${lev.naam}</button>` : ''}
        </div>`;
      }

      container.innerHTML = Object.keys(bestelLijstPerLev).length ? html : '<div class="card">Alles is voldoende op voorraad!</div>';
    }

    window.mailBestelling = (levId, itemsJson) => {
      const lev = state.leveranciers.find(l => l.id === levId);
      const items = JSON.parse(decodeURIComponent(itemsJson));
      const body = "Geachte medewerker,\n\nGraag zou ik de volgende artikelen willen bestellen:\n\n" + 
                   items.map(i => "- " + i.aantal + " verpakking(en) " + i.naam).join("\n") + 
                   "\n\nMet vriendelijke groet.";
      window.location.href = `mailto:${lev.email}?subject=Bestelling medische hulpmiddelen&body=${encodeURIComponent(body)}`;
    };

    window.saveConfig = () => {
      state.besteldagen = parseInt(document.getElementById('inp-besteldagen').value);
      saveToDisk();
      alert('Instellingen opgeslagen!');
    };

    // Initial render
    renderItems();
  </script>
</body>
</html>
